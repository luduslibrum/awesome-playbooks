{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "Four Playbook templates - F5BigIP",
        "description": "This is a consolidated json file for deploying 4 playbooks.",
        "mainSteps": [
            " Base Playbook: 1. Generates Access Token from F5BigIP using Login Provider Name, Host URL, Username and Password as inputs.",
            " BlockIP Playbook: 1. Fetches a list of potentially malicious IP addresses 2.If IP address not present in IP address list, then adds the IP address to IP address list.",
            " Block URL: 1. Fetches a list of potentially malicious URLs 2. If URL not present in URL Blocklist Category, then adds the URL to URL Blocklist Category.",
            " Enrichment IP: 1. Fetches a list of potentially malicious IP addresses 2. Enriches Incident Comment with IP status information."
        ],
        "prerequisites": [
            "1. F5BigIP Host url should be known.",
            "2. F5BigIP firewall username and password should be known.",
            "3. F5BigIP environment should be accessible with the credentials.",
            "4. A Firewall Policy Rule should be created for blocking of IP.",
            "5. An address list should be created for blocking IP.",
            "6. The address list should be a part of Firewall Policy Rule.",
            "7. URL Blocklist Category should be created for blocking URLs."
        ],
        "lastUpdateTime": "2021-07-26T00:00:00.000Z",
        "entities": [ "Url", "Ip" ],
        "tags": [ "Enrichment", "Remediation" ],
        "support": {
            "tier": "community"
        },
        "author": {
            "name": "Accenture"
        }
    },
    "parameters": {
        "BlockIPPlaybookName": {
            "defaultValue": "F5BigIP-Block-IP",
            "type": "String",
            "metadata": {
                "description": "Enter name for Block IP playbook without spaces"
            },
            "minLength": 3
        },
        "BlockURLPlaybookName": {
            "defaultValue": "F5BigIP-Block-URL",
            "type": "String",
            "metadata": {
                "description": "Enter name for Block URL playbook without spaces"
            },
            "minLength": 3
        },
        "EnrichmentIPPlaybookName": {
            "defaultValue": "F5BigIP-Enrichment-IP",
            "type": "String",
            "metadata": {
                "description": "Enter name for Enrichment IP playbook without spaces"
            },
            "minLength": 3
        },

        "BasePlaybookName": {
            "defaultValue": "F5BigIP_Base",
            "type": "String",
            "metadata": {
                "description": "Enter name for Base playbook name without spaces"
            },
            "minLength": 3
        },
        "IPAddressListName": {
            "type": "string",
            "metadata": {
                "description": "Enter ip address list name"
            },
            "minLength": 3
        },
        "URLBlocklistcategoryName": {
            "type": "String",
            "metadata": {
                "description": "Enter URL Blocklist Category name"
            },
            "minLength": 3
        },
        "HostURL": {
            "type": "string",
            "metadata": {
                "description": "Enter host url"
            }
        },
        "Username": {
            "type": "string",
            "metadata": {
                "description": "Enter Username"
            }
        },
        "Password": {
            "type": "securestring",
            "metadata": {
                "description": "Enter password"
            }
        }

    },
    "variables": {
        "AzureSentinel_Connection": "[concat('Azuresentienl-', 'F5BigIPPlaybooks')]",
        "F5BigIP_Base_id": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Logic/workflows/',parameters('BasePlaybookName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('BasePlaybookName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "F5BigIPHost": {
                            "defaultValue": "[parameters('HostURL')]",
                            "type": "String"
                        },
                        "password": {
                            "defaultValue": "[parameters('Password')]",
                            "type": "SecureString"
                        },
                        "username": {
                            "defaultValue": "[parameters('Username')]",
                            "type": "String"
                        }
                    },
                    "triggers": {
                        "manual": {
                            "type": "Request",
                            "kind": "Http",
                            "inputs": {}
                        }
                    },
                    "actions": {
                        "HTTP_-_Get_Access_Token": {
                            "runAfter": {
                                "Initialize_variable_loginProviderName_for_F5_environment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Http",
                            "inputs": {
                                "body": {
                                    "loginProviderName": "@{variables('loginProviderName')}",
                                    "password": "@{parameters('password')}",
                                    "username": "@{parameters('username')}"
                                },
                                "method": "POST",
                                "uri": "@{parameters('F5BigIPHost')}/mgmt/shared/authn/login"
                            }
                        },
                        "Initialize_variable_loginProviderName_for_F5_environment": {
                            "runAfter": {},
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "loginProviderName",
                                        "type": "string",
                                        "value": "tmos"
                                    }
                                ]
                            }
                        },
                        "Response": {
                            "runAfter": {
                                "HTTP_-_Get_Access_Token": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Response",
                            "kind": "Http",
                            "inputs": {
                                "body": {
                                    "F5BigIPHost": "@{parameters('F5BigIPHost')}",
                                    "X-F5-Auth-Token": "@{body('HTTP_-_Get_Access_Token')?['token']?['token']}"
                                },
                                "statusCode": 200
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {}
            }
        },
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('BlockIPPlaybookName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        },
                        "AddressListName": {
                            "defaultValue": "[parameters('IPAddressListName')]",
                            "type": "String"
                        }
                    },
                    "triggers": {
                        "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "body": {
                                    "callback_url": "@{listCallbackUrl()}"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Check_if_body_present_in_Azure_Sentinel_incident": {
                            "actions": {
                                "Add_comment_to_incident_(V3)": {
                                    "runAfter": {
                                        "Compose_Image_to_add_in_the_Incident": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "body": {
                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                            "message": "<p>@{outputs('Compose_Image_to_add_in_the_Incident')} <strong>Block-IP Playbook ran and added the below IP address(es) to “</strong><strong>@{parameters('AddressListName')}</strong><strong>” address list.</strong><br>\n@{body('Create_HTML_table_to_comment_in_the_Incident')}</p>"
                                        },
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/Incidents/Comment"
                                    },
                                    "description": "This adds comments to the incident"
                                },
                                "Compose_Image_to_add_in_the_Incident": {
                                    "runAfter": {
                                        "Create_HTML_table_to_comment_in_the_Incident": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Compose",
                                    "inputs": "<img src=\"https://www.bing.com/th?id=OIP.7EfUwjpb7ziFgcqJgEla3gHaHP&w=119&h=102&c=8&rs=1&qlt=90&o=6&dpr=1.5&pid=3.1&rm=2\" alt=\"Lamp\" width=\"32\" height=\"32\">",
                                    "description": "This composes the F5 image to update in the incident"
                                },
                                "Condition__to_check_if_predefined_address_list_is_present_in_F5_Big_IP": {
                                    "actions": {
                                        "For_each_IP": {
                                            "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                                            "actions": {
                                                "Condition_to_check_if_IP_is_present_in_predefined_address_list": {
                                                    "actions": {
                                                        "Append_to_array_variable_consolidated_comments_in_case_of_IP_already_blocked": {
                                                            "runAfter": {
                                                                "Set_variable_Comment_in_case_of_IP_already_blocked": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "ConsolidatedComments",
                                                                "value": "@variables('Comment')"
                                                            },
                                                            "description": "This appends consolidated comments"
                                                        },
                                                        "Set_variable_Comment_in_case_of_IP_already_blocked": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Comment",
                                                                "value": {
                                                                    "Action": "IP Added to address list",
                                                                    "Current_Status": "Blocked",
                                                                    "IP_Address": " @{items('For_each_IP')?['Address']}",
                                                                    "Previous_Status": "Blocked"
                                                                }
                                                            },
                                                            "description": "This sets comment variable if IP already blocked"
                                                        },
                                                        "Set_variable_Success_if_Ip_already_blocked": {
                                                            "runAfter": {
                                                                "Append_to_array_variable_consolidated_comments_in_case_of_IP_already_blocked": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Success",
                                                                "value": "Success"
                                                            },
                                                            "description": "This sets the success variable"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Set_variable_fqdns": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Append_to_array_variable_Address_list_members": {
                                                                "runAfter": {
                                                                    "Set_variable_Address_List_Member": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "AppendToArrayVariable",
                                                                "inputs": {
                                                                    "name": "AddressListMembers",
                                                                    "value": "@variables('AddressListMember')"
                                                                },
                                                                "description": "This Appends Address to Address List Members"
                                                            },
                                                            "Condition_to_check_if_IP_added_to_address_list": {
                                                                "actions": {
                                                                    "Append_to_array_variable_in_case_if_IP_is_added_successfully": {
                                                                        "runAfter": {
                                                                            "Set_variable_comment_in_case_if_IP_is_added_successfully": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "AppendToArrayVariable",
                                                                        "inputs": {
                                                                            "name": "ConsolidatedComments",
                                                                            "value": "@variables('Comment')"
                                                                        },
                                                                        "description": "This appends consolidated comments"
                                                                    },
                                                                    "Set_variable_Success_if_IP_blocked": {
                                                                        "runAfter": {
                                                                            "Append_to_array_variable_in_case_if_IP_is_added_successfully": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "Success",
                                                                            "value": "Success"
                                                                        },
                                                                        "description": "This sets the success variable"
                                                                    },
                                                                    "Set_variable_comment_in_case_if_IP_is_added_successfully": {
                                                                        "runAfter": {},
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "Comment",
                                                                            "value": {
                                                                                "Action": "IP Added to address list by playbook",
                                                                                "Current_Status": "Blocked",
                                                                                "IP_Address": " @{items('For_each_IP')?['Address']}",
                                                                                "Previous_Status": "Allowed"
                                                                            }
                                                                        },
                                                                        "description": "This sets comment variable if IP blocked"
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "HTTP-Add_IP_to_Address_List": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "else": {
                                                                    "actions": {
                                                                        "Append_to_array_variable_in_case_if_IP_is_not_added_successfully": {
                                                                            "runAfter": {
                                                                                "Set_variable_Success_if_IP_not_blocked": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "AppendToArrayVariable",
                                                                            "inputs": {
                                                                                "name": "ConsolidatedComments",
                                                                                "value": "@variables('Comment')"
                                                                            },
                                                                            "description": "This appends consolidated comments"
                                                                        },
                                                                        "Set_variable_Success_if_IP_not_blocked": {
                                                                            "runAfter": {
                                                                                "Set_variable_comment_in_case_if_IP_is_not_added_successfully": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "Success",
                                                                                "value": "Failure"
                                                                            },
                                                                            "description": "This sets the success variable"
                                                                        },
                                                                        "Set_variable_comment_in_case_if_IP_is_not_added_successfully": {
                                                                            "runAfter": {},
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "Comment",
                                                                                "value": {
                                                                                    "Action": "Failed to add IP to address list by playbook",
                                                                                    "Current_Status": "Allowed",
                                                                                    "IP_Address": " @{items('For_each_IP')?['Address']}",
                                                                                    "Previous_Status": "Allowed"
                                                                                }
                                                                            },
                                                                            "description": "This sets comment variable if IP not blocked"
                                                                        }
                                                                    }
                                                                },
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "equals": [
                                                                                "@outputs('HTTP-Add_IP_to_Address_List')['statusCode']",
                                                                                200
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                "type": "If",
                                                                "description": "This checks if Ip is blocked"
                                                            },
                                                            "F5BigIP_Base_call": {
                                                                "runAfter": {
                                                                    "Append_to_array_variable_Address_list_members": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Workflow",
                                                                "inputs": {
                                                                    "host": {
                                                                        "triggerName": "manual",
                                                                        "workflow": {
                                                                            "id": "[variables('F5BigIP_Base_id')]"
                                                                        }
                                                                    }
                                                                },
                                                                "description": "This again calls the F5 Big Ip for generating the token"
                                                            },
                                                            "HTTP-Add_IP_to_Address_List": {
                                                                "runAfter": {
                                                                    "F5BigIP_Base_call": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "body": {
                                                                        "addresses": "@variables('AddressListMembers')",
                                                                        "fqdns": "@variables('fqdns')"
                                                                    },
                                                                    "headers": {
                                                                        "X-F5-Auth-Token": "@{body('F5BigIP_Base_call')?['X-F5-Auth-Token']}"
                                                                    },
                                                                    "method": "PATCH",
                                                                    "uri": "@{body('F5BigIP_Base_call')?['F5BigIPHost']}/mgmt/tm/security/firewall/address-list/@{parameters('AddressListName')}"
                                                                },
                                                                "description": "This updates the Address list with the new malicious IP"
                                                            },
                                                            "Set_variable_Address_List_Member": {
                                                                "runAfter": {},
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "AddressListMember",
                                                                    "value": {
                                                                        "name": "@{items('For_each_IP')?['Address']}"
                                                                    }
                                                                },
                                                                "description": "This sets the Address list member"
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "greater": [
                                                                    "@length(body('Filter_array_IP_from_address_list'))",
                                                                    0
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If",
                                                    "description": "This checks if IP is present in address list"
                                                },
                                                "Filter_array_IP_from_address_list": {
                                                    "runAfter": {},
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('HTTP-Get_specific_Address_list')?['addresses']",
                                                        "where": "@equals(item()?['name'], items('For_each_IP')?['Address'])"
                                                    },
                                                    "description": "This filters the IP from address list"
                                                },
                                                "Set_variable_Address_List_Members": {
                                                    "runAfter": {
                                                        "Filter_array_IP_from_address_list": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "AddressListMembers",
                                                        "value": "@body('HTTP-Get_specific_Address_list')?['addresses']"
                                                    },
                                                    "description": "This sets the Address List members"
                                                },
                                                "Set_variable_fqdns": {
                                                    "runAfter": {
                                                        "Set_variable_Address_List_Members": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "fqdns",
                                                        "value": "@body('HTTP-Get_specific_Address_list')?['fqdns']"
                                                    },
                                                    "description": "This sets the fqdns"
                                                }
                                            },
                                            "runAfter": {},
                                            "type": "Foreach",
                                            "runtimeConfiguration": {
                                                "concurrency": {
                                                    "repetitions": 1
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "HTTP-Get_specific_Address_list": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Terminate_if_Address_list_not_present": {
                                                "runAfter": {},
                                                "type": "Terminate",
                                                "inputs": {
                                                    "runError": {
                                                        "code": "404",
                                                        "message": "Pre-defined address list not present to block IP "
                                                    },
                                                    "runStatus": "Failed"
                                                },
                                                "description": "This Terminates the playbook if Address list is not present"
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@outputs('HTTP-Get_specific_Address_list')['statusCode']",
                                                    200
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "This checks if address list is present in F5 environment"
                                },
                                "Condition_to_check_if_Ip_blocked_Successfully": {
                                    "actions": {
                                        "Update_incident": {
                                            "runAfter": {},
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "classification": {
                                                        "ClassificationAndReason": "BenignPositive - SuspiciousButExpected",
                                                        "ClassificationReasonText": "Incident Closed from playbook F5 Big Ip_BlockIP"
                                                    },
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "status": "Closed"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "put",
                                                "path": "/Incidents"
                                            },
                                            "description": "This closes the incident"
                                        }
                                    },
                                    "runAfter": {
                                        "Add_comment_to_incident_(V3)": [
                                            "Succeeded"
                                        ]
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@variables('Success')",
                                                    "Success"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Create_HTML_table_to_comment_in_the_Incident": {
                                    "runAfter": {
                                        "Condition__to_check_if_predefined_address_list_is_present_in_F5_Big_IP": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Table",
                                    "inputs": {
                                        "columns": [
                                            {
                                                "header": "IP Address",
                                                "value": "@item()?['IP_Address']"
                                            },
                                            {
                                                "header": "Previous Status",
                                                "value": "@item()?['Previous_Status']"
                                            },
                                            {
                                                "header": "Current Status",
                                                "value": "@item()?['Current_Status']"
                                            },
                                            {
                                                "header": "Action",
                                                "value": "@item()?['Action']"
                                            }
                                        ],
                                        "format": "HTML",
                                        "from": "@variables('ConsolidatedComments')"
                                    },
                                    "description": "This creates a HTML table to update in the incident"
                                },
                                "F5BigIP_Base": {
                                    "runAfter": {},
                                    "type": "Workflow",
                                    "inputs": {
                                        "host": {
                                            "triggerName": "manual",
                                            "workflow": {
                                                "id": "[variables('F5BigIP_Base_id')]"
                                            }
                                        }
                                    },
                                    "description": "This calls the F5 Big IP base playbook for the authentication token"
                                },
                                "HTTP-Get_specific_Address_list": {
                                    "runAfter": {
                                        "F5BigIP_Base": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Http",
                                    "inputs": {
                                        "headers": {
                                            "X-F5-Auth-Token": "@{body('F5BigIP_Base')?['X-F5-Auth-Token']}"
                                        },
                                        "method": "GET",
                                        "uri": "@{body('F5BigIP_Base')?['F5BigIPHost']}/mgmt/tm/security/firewall/address-list/@{parameters('AddressListName')}"
                                    },
                                    "description": "This gets the contents of specific address list"
                                }
                            },
                            "runAfter": {
                                "Initialize_variable_AddressListMember": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Terminate_if_IP_not_found_in_sentinel_body": {
                                        "runAfter": {},
                                        "type": "Terminate",
                                        "inputs": {
                                            "runError": {
                                                "code": "404",
                                                "message": "IP Address not found in Azure Sentinel Incident"
                                            },
                                            "runStatus": "Failed"
                                        },
                                        "description": "This Terminates the Playbook if IP not found in the body"
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "contains": [
                                            "@outputs('Entities_-_Get_IPs')",
                                            "body"
                                        ]
                                    },
                                    {
                                        "greater": [
                                            "@length(body('Entities_-_Get_IPs')?['IPs'])",
                                            0
                                        ]
                                    }
                                ]
                            },
                            "type": "If",
                            "description": "This checks if body is present in Azure Sentinel"
                        },
                        "Entities_-_Get_IPs": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/entities/ip"
                            }
                        },
                        "Initialize_variable_AddressListMember": {
                            "runAfter": {
                                "Initialize_variable_fqdns": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "AddressListMember",
                                        "type": "object"
                                    }
                                ]
                            },
                            "description": "This holds the Address List Member"
                        },
                        "Initialize_variable_AddressListMembers": {
                            "runAfter": {
                                "Initialize_variable_Consolidated_Comment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "AddressListMembers",
                                        "type": "array"
                                    }
                                ]
                            },
                            "description": "This holds the Address List Members"
                        },
                        "Initialize_variable_Comment": {
                            "runAfter": {
                                "Entities_-_Get_IPs": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Comment",
                                        "type": "object"
                                    }
                                ]
                            },
                            "description": "This holds the value of comment variable"
                        },
                        "Initialize_variable_Consolidated_Comment": {
                            "runAfter": {
                                "Initialize_variable_Success": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "ConsolidatedComments",
                                        "type": "array"
                                    }
                                ]
                            },
                            "description": "This holds the value of consolidated comments"
                        },
                        "Initialize_variable_Success": {
                            "runAfter": {
                                "Initialize_variable_Comment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Success",
                                        "type": "string"
                                    }
                                ]
                            },
                            "description": "This holds the value of Success variable"
                        },
                        "Initialize_variable_fqdns": {
                            "runAfter": {
                                "Initialize_variable_AddressListMembers": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "fqdns",
                                        "type": "array"
                                    }
                                ]
                            },
                            "description": "This holds the fqdns"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                                "connectionName": "[variables('AzureSentinel_Connection')]",
                                "id": "[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',resourceGroup().location,'/managedApis/azuresentinel')]",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('BlockURLPlaybookName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        },
                        "URLBlocklistcategoryName": {
                            "defaultValue": "[parameters('URLBlocklistcategoryName')]",
                            "type": "String"
                        }
                    },
                    "triggers": {
                        "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "body": {
                                    "callback_url": "@{listCallbackUrl()}"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Check_if_body_present_in_Azure_Sentinel_incident": {
                            "actions": {
                                "Add_comment_to_incident_(V3)": {
                                    "runAfter": {
                                        "Compose_Image_to_add_in_the_Incident": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "body": {
                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                            "message": "<p>@{outputs('Compose_Image_to_add_in_the_Incident')} <strong>Block-URL Playbook ran and added the below URL’s to “</strong><strong>@{parameters('URLBlocklistcategoryName')}</strong><strong>” URL block list category .</strong><br>\n@{body('Create_HTML_table_to_comment_in_the_Incident')}</p>"
                                        },
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/Incidents/Comment"
                                    },
                                    "description": "This adds comments to the incident"
                                },
                                "Compose_Image_to_add_in_the_Incident": {
                                    "runAfter": {
                                        "Create_HTML_table_to_comment_in_the_Incident": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Compose",
                                    "inputs": "<img src=\"https://www.bing.com/th?id=OIP.7EfUwjpb7ziFgcqJgEla3gHaHP&w=119&h=102&c=8&rs=1&qlt=90&o=6&dpr=1.5&pid=3.1&rm=2\" alt=\"Lamp\" width=\"32\" height=\"32\">",
                                    "description": "This composes the F5 image to update in the incident"
                                },
                                "Condition__to_check_if_predefined_URL_block_list_is_present_in_F5_Big_IP": {
                                    "actions": {
                                        "For_each_URL": {
                                            "foreach": "@body('Entities_-_Get_URLs')?['URLs']",
                                            "actions": {
                                                "Condition_to_check_if_URL_is_present_in_predefined_block_URL_category_list": {
                                                    "actions": {
                                                        "Append_to_array_variable_consolidated_comments_in_case_of_URL_already_blocked": {
                                                            "runAfter": {
                                                                "Set_variable_Comment_in_case_of_URL_already_blocked": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "ConsolidatedComments",
                                                                "value": "@variables('Comment')"
                                                            },
                                                            "description": "This appends consolidated comments"
                                                        },
                                                        "Set_variable_Comment_in_case_of_URL_already_blocked": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Comment",
                                                                "value": {
                                                                    "Action": "No Action taken as URL already added to URL Blocklist category",
                                                                    "Current_Status": "Blocked",
                                                                    "Previous_Status": "Blocked",
                                                                    "URL": " @{items('For_each_URL')?['Url']}",
                                                                    "URLblocklistname": "@{parameters('URLBlocklistcategoryName')}"
                                                                }
                                                            },
                                                            "description": "This sets comment variable if URL already blocked"
                                                        },
                                                        "Set_variable_Success_if_URL_already_blocked": {
                                                            "runAfter": {
                                                                "Append_to_array_variable_consolidated_comments_in_case_of_URL_already_blocked": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Success",
                                                                "value": "Success"
                                                            },
                                                            "description": "This sets the success variable"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Set_variable_Address_List_Members": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Append_to_array_variable_Address_list_members": {
                                                                "runAfter": {
                                                                    "Set_variable_Address_List_Member": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "AppendToArrayVariable",
                                                                "inputs": {
                                                                    "name": "AddressListMembers",
                                                                    "value": "@variables('AddressListMember')"
                                                                },
                                                                "description": "This Appends URL to Block list Memebers"
                                                            },
                                                            "Condition_to_check_if_URL_added_to_block_list_category": {
                                                                "actions": {
                                                                    "Append_to_array_variable_in_case_if_URL_is_added_successfully": {
                                                                        "runAfter": {
                                                                            "Set_variable_comment_in_case_if_URL_is_added_successfully": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "AppendToArrayVariable",
                                                                        "inputs": {
                                                                            "name": "ConsolidatedComments",
                                                                            "value": "@variables('Comment')"
                                                                        },
                                                                        "description": "This appends consolidated comments"
                                                                    },
                                                                    "Set_variable_Success_if_URL_blocked": {
                                                                        "runAfter": {
                                                                            "Append_to_array_variable_in_case_if_URL_is_added_successfully": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "Success",
                                                                            "value": "Success"
                                                                        },
                                                                        "description": "This sets the success variable"
                                                                    },
                                                                    "Set_variable_comment_in_case_if_URL_is_added_successfully": {
                                                                        "runAfter": {},
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "Comment",
                                                                            "value": {
                                                                                "Action": "Added to URL Blocklist category by playbook",
                                                                                "Current_Status": "Blocked",
                                                                                "Previous_Status": "Allowed",
                                                                                "URL": " @{items('For_each_URL')?['Url']}",
                                                                                "URLblocklistname": "@{parameters('URLBlocklistcategoryName')}"
                                                                            }
                                                                        },
                                                                        "description": "This sets comment variable if URL is blocked"
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "HTTP-Add_URL_to_URL_Block_List_category": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "else": {
                                                                    "actions": {
                                                                        "Append_to_array_variable_in_case_if_URL_is_not_added_successfully": {
                                                                            "runAfter": {
                                                                                "Set_variable_comment_in_case_if_URL_is_not_added_successfully": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "AppendToArrayVariable",
                                                                            "inputs": {
                                                                                "name": "ConsolidatedComments",
                                                                                "value": "@variables('Comment')"
                                                                            },
                                                                            "description": "This appends consolidated comments"
                                                                        },
                                                                        "Set_variable_Success_if_URL_not_blocked": {
                                                                            "runAfter": {
                                                                                "Append_to_array_variable_in_case_if_URL_is_not_added_successfully": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "Success",
                                                                                "value": "Failure"
                                                                            },
                                                                            "description": "This sets the success variable"
                                                                        },
                                                                        "Set_variable_comment_in_case_if_URL_is_not_added_successfully": {
                                                                            "runAfter": {},
                                                                            "type": "SetVariable",
                                                                            "inputs": {
                                                                                "name": "Comment",
                                                                                "value": {
                                                                                    "Action": "Failed to add URL to URL Blocklist category by playbook",
                                                                                    "Current_Status": "Allowed",
                                                                                    "Previous_Status": "Allowed",
                                                                                    "URL": " @{items('For_each_URL')?['Url']}",
                                                                                    "URLblocklistname": "@{parameters('URLBlocklistcategoryName')}"
                                                                                }
                                                                            },
                                                                            "description": "This sets comment variable if URL is not blocked"
                                                                        }
                                                                    }
                                                                },
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "equals": [
                                                                                "@outputs('HTTP-Add_URL_to_URL_Block_List_category')['statusCode']",
                                                                                200
                                                                            ]
                                                                        }
                                                                    ]
                                                                },
                                                                "type": "If",
                                                                "description": "This checks if URL is blocked"
                                                            },
                                                            "F5BigIP_Base_call": {
                                                                "runAfter": {
                                                                    "Append_to_array_variable_Address_list_members": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Workflow",
                                                                "inputs": {
                                                                    "host": {
                                                                        "triggerName": "manual",
                                                                        "workflow": {
                                                                            "id": "[variables('F5BigIP_Base_id')]"
                                                                        }
                                                                    }
                                                                },
                                                                "description": "This again calls the F5 Big URL for generating the token"
                                                            },
                                                            "HTTP-Add_URL_to_URL_Block_List_category": {
                                                                "runAfter": {
                                                                    "F5BigIP_Base_call": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "body": {
                                                                        "urls": "@variables('AddressListMembers')"
                                                                    },
                                                                    "headers": {
                                                                        "Content-Type": "application/json",
                                                                        "X-F5-Auth-Token": "@{body('F5BigIP_Base_call')?['X-F5-Auth-Token']}"
                                                                    },
                                                                    "method": "PATCH",
                                                                    "uri": "@{body('F5BigIP_Base_call')?['F5BigIPHost']}/mgmt/tm/sys/url-db/url-category/@{parameters('URLBlocklistcategoryName')}"
                                                                }
                                                            },
                                                            "Set_variable_Address_List_Member": {
                                                                "runAfter": {},
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "AddressListMember",
                                                                    "value": {
                                                                        "name": "@{items('For_each_URL')?['Url']}"
                                                                    }
                                                                },
                                                                "description": "This sets the Address list member"
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "greater": [
                                                                    "@length(body('Filter_array_URL_from_URL_block_list'))",
                                                                    0
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If",
                                                    "description": "This checks if URL is present in URL block list"
                                                },
                                                "Filter_array_URL_from_URL_block_list": {
                                                    "runAfter": {},
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('HTTP-Get_specific_URL_Block_list_category')?['urls']",
                                                        "where": "@equals(item()?['name'], items('For_each_URL')?['Url'])"
                                                    },
                                                    "description": "This filters the URL from URL block list"
                                                },
                                                "Set_variable_Address_List_Members": {
                                                    "runAfter": {
                                                        "Filter_array_URL_from_URL_block_list": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "AddressListMembers",
                                                        "value": "@body('HTTP-Get_specific_URL_Block_list_category')?['urls']"
                                                    },
                                                    "description": "This sets the Address List members"
                                                }
                                            },
                                            "runAfter": {},
                                            "type": "Foreach",
                                            "runtimeConfiguration": {
                                                "concurrency": {
                                                    "repetitions": 1
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "HTTP-Get_specific_URL_Block_list_category": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Terminate_if_URL_block_list_not_present": {
                                                "runAfter": {},
                                                "type": "Terminate",
                                                "inputs": {
                                                    "runError": {
                                                        "code": "404",
                                                        "message": "There is no predefined URL blocklist present with the name @{parameters('URLBlocklistcategoryName')}"
                                                    },
                                                    "runStatus": "Failed"
                                                },
                                                "description": "This Terminates the playbook if block URL category is not present"
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@outputs('HTTP-Get_specific_URL_Block_list_category')['statusCode']",
                                                    200
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "This checks if URL block list is present in F5 environment"
                                },
                                "Condition_to_check_if_URL_blocked_Successfully": {
                                    "actions": {
                                        "Update_incident": {
                                            "runAfter": {},
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "classification": {
                                                        "ClassificationAndReason": "BenignPositive - SuspiciousButExpected",
                                                        "ClassificationReasonText": "F5 Big IP_Block_URL playbook ran and closed this incident"
                                                    },
                                                    "incidentArmId": "@triggerBody()?['object']?['id']",
                                                    "status": "Closed"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                    }
                                                },
                                                "method": "put",
                                                "path": "/Incidents"
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Add_comment_to_incident_(V3)": [
                                            "Succeeded"
                                        ]
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@variables('Success')",
                                                    "Success"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Create_HTML_table_to_comment_in_the_Incident": {
                                    "runAfter": {
                                        "Condition__to_check_if_predefined_URL_block_list_is_present_in_F5_Big_IP": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Table",
                                    "inputs": {
                                        "columns": [
                                            {
                                                "header": "URL",
                                                "value": "@item()?['URL']"
                                            },
                                            {
                                                "header": "Previous Status",
                                                "value": "@item()?['Previous_Status']"
                                            },
                                            {
                                                "header": "Current Status",
                                                "value": "@item()?['Current_Status']"
                                            },
                                            {
                                                "header": "Action",
                                                "value": "@item()?['Action']"
                                            }
                                        ],
                                        "format": "HTML",
                                        "from": "@variables('ConsolidatedComments')"
                                    },
                                    "description": "This creates a HTML table to update in the incident"
                                },
                                "F5BigIP_Base": {
                                    "runAfter": {},
                                    "type": "Workflow",
                                    "inputs": {
                                        "host": {
                                            "triggerName": "manual",
                                            "workflow": {
                                                "id": "[variables('F5BigIP_Base_id')]"
                                            }
                                        }
                                    },
                                    "description": "This calls the F5 Big URL base playbook for the authentication token"
                                },
                                "HTTP-Get_specific_URL_Block_list_category": {
                                    "runAfter": {
                                        "F5BigIP_Base": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Http",
                                    "inputs": {
                                        "headers": {
                                            "X-F5-Auth-Token": "@{body('F5BigIP_Base')?['X-F5-Auth-Token']}"
                                        },
                                        "method": "GET",
                                        "uri": "@{body('F5BigIP_Base')?['F5BigIPHost']}/mgmt/tm/sys/url-db/url-category/@{parameters('URLBlocklistcategoryName')}"
                                    },
                                    "description": "This gets the contents of specific URL block list"
                                }
                            },
                            "runAfter": {
                                "Initialize_variable_Success": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Terminate_if_URL_not_found_in_sentinel_body": {
                                        "runAfter": {},
                                        "type": "Terminate",
                                        "inputs": {
                                            "runError": {
                                                "code": "404",
                                                "message": "URL not found in Azure Sentinel Incident"
                                            },
                                            "runStatus": "Failed"
                                        },
                                        "description": "This Terminates the Playbook if URL not found in the body"
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "contains": [
                                            "@outputs('Entities_-_Get_URLs')",
                                            "body"
                                        ]
                                    },
                                    {
                                        "greater": [
                                            "@length(body('Entities_-_Get_URLs')?['URLs'])",
                                            0
                                        ]
                                    }
                                ]
                            },
                            "type": "If",
                            "description": "This checks if body is present in Azure Sentinel"
                        },
                        "Entities_-_Get_URLs": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/entities/url"
                            }
                        },
                        "Initialize_variable_AddressListMember": {
                            "runAfter": {
                                "Initialize_variable_AddressListMembers": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "AddressListMember",
                                        "type": "object"
                                    }
                                ]
                            },
                            "description": "This holds the Address List Member"
                        },
                        "Initialize_variable_AddressListMembers": {
                            "runAfter": {
                                "Initialize_variable_Consolidated_Comment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "AddressListMembers",
                                        "type": "array"
                                    }
                                ]
                            },
                            "description": "This holds the Address List Members"
                        },
                        "Initialize_variable_Comment": {
                            "runAfter": {
                                "Entities_-_Get_URLs": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Comment",
                                        "type": "object"
                                    }
                                ]
                            },
                            "description": "This holds the value of comment variable"
                        },
                        "Initialize_variable_Consolidated_Comment": {
                            "runAfter": {
                                "Initialize_variable_Comment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "ConsolidatedComments",
                                        "type": "array"
                                    }
                                ]
                            },
                            "description": "This holds the value of consolidated comments"
                        },
                        "Initialize_variable_Success": {
                            "runAfter": {
                                "Initialize_variable_AddressListMember": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Success",
                                        "type": "string"
                                    }
                                ]
                            },
                            "description": "This holds the value of Success variable"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                                "connectionName": "[variables('AzureSentinel_Connection')]",
                                "id": "[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',resourceGroup().location,'/managedApis/azuresentinel')]",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('EnrichmentIPPlaybookName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        },
                        "AddressListName": {
                            "defaultValue": "[parameters('IPAddressListName')]",
                            "type": "String"
                        }
                    },
                    "triggers": {
                        "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "body": {
                                    "callback_url": "@{listCallbackUrl()}"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Check_if_body_present_in_Azure_Sentinel_incident": {
                            "actions": {
                                "Add_comment_to_incident_(V3)": {
                                    "runAfter": {
                                        "Compose_Image_to_add_in_the_Incident": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "body": {
                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                            "message": "<p>@{outputs('Compose_Image_to_add_in_the_Incident')}<strong>Enrichment Playbook captured the below information from F5 Big IP.<br>\n</strong><strong>@{variables('FirewallRuleName')}</strong><strong></strong><br>\n@{body('Create_HTML_table_to_comment_in_the_Incident')}</p>"
                                        },
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "path": "/Incidents/Comment"
                                    }
                                },
                                "Compose_Image_to_add_in_the_Incident": {
                                    "runAfter": {
                                        "Create_HTML_table_to_comment_in_the_Incident": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Compose",
                                    "inputs": "<img src=\"https://www.bing.com/th?id=OIP.7EfUwjpb7ziFgcqJgEla3gHaHP&w=119&h=102&c=8&rs=1&qlt=90&o=6&dpr=1.5&pid=3.1&rm=2\" alt=\"Lamp\" width=\"32\" height=\"32\">",
                                    "description": "This composes the F5 image to update in the incident"
                                },
                                "Condition__to_check_if_predefined_address_list_is_present_in_F5_Big_IP": {
                                    "actions": {
                                        "For_each_IP": {
                                            "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
                                            "actions": {
                                                "Condition_to_check_if_IP_is_present_in_predefined_address_list": {
                                                    "actions": {
                                                        "Append_to_array_variable_consolidated_comments_in_case_of_IP_already_blocked": {
                                                            "runAfter": {
                                                                "Set_variable_comment_in_case_of_IP_already_blocked": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "ConsolidatedComments",
                                                                "value": "@variables('Comment')"
                                                            },
                                                            "description": "This appends consolidated comments"
                                                        },
                                                        "Set_variable_comment_in_case_of_IP_already_blocked": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "Comment",
                                                                "value": {
                                                                    "Action": "Yes",
                                                                    "IP_Address": " @{items('For_each_IP')?['Address']}",
                                                                    "Status": "Blocked"
                                                                }
                                                            },
                                                            "description": "This sets comment variable if IP already blocked"
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Filter_array_IP_from_address_list": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Append_to_array_variable_in_case_if_IP_is_not_blocked": {
                                                                "runAfter": {
                                                                    "Set_variable_comment_in_case_if_IP_is_not_blocked": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "AppendToArrayVariable",
                                                                "inputs": {
                                                                    "name": "ConsolidatedComments",
                                                                    "value": "@variables('Comment')"
                                                                },
                                                                "description": "This appends consolidated comments"
                                                            },
                                                            "Set_variable_comment_in_case_if_IP_is_not_blocked": {
                                                                "runAfter": {},
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "Comment",
                                                                    "value": {
                                                                        "Action": "No",
                                                                        "IP_Address": " @{items('For_each_IP')?['Address']}",
                                                                        "Status": "Allowed"
                                                                    }
                                                                },
                                                                "description": "This sets comment variable if IP already blocked"
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "greater": [
                                                                    "@length(body('Filter_array_IP_from_address_list'))",
                                                                    0
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If",
                                                    "description": "This checks if IP is present in address list"
                                                },
                                                "Filter_array_IP_from_address_list": {
                                                    "runAfter": {},
                                                    "type": "Query",
                                                    "inputs": {
                                                        "from": "@body('HTTP-Get_specific_Address_list')?['addresses']",
                                                        "where": "@equals(item()?['name'], items('For_each_IP')?['Address'])"
                                                    },
                                                    "description": "This filters the IP from address list"
                                                }
                                            },
                                            "runAfter": {},
                                            "type": "Foreach",
                                            "description": "Loops on each IP",
                                            "runtimeConfiguration": {
                                                "concurrency": {
                                                    "repetitions": 1
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "HTTP-Get_specific_Address_list": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Append_to_array_variable_consolidated_comments_if_address_list_not_present": {
                                                "runAfter": {
                                                    "Set_variable_comment_if_address_list_is_not_present": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "AppendToArrayVariable",
                                                "inputs": {
                                                    "name": "ConsolidatedComments",
                                                    "value": "@variables('Comment')"
                                                },
                                                "description": "This appends consolidated comments if address list is not present"
                                            },
                                            "Set_variable_comment_if_address_list_is_not_present": {
                                                "runAfter": {},
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "Comment",
                                                    "value": {
                                                        "Action": "Address List not present in F5",
                                                        "IP_Address": "NA",
                                                        "Status": "NA"
                                                    }
                                                },
                                                "description": "This sets comment variable if address list not present"
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@outputs('HTTP-Get_specific_Address_list')['statusCode']",
                                                    200
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "This checks if IP address is present in F5 Big IP"
                                },
                                "Condition_to_check_if__predefined_address_list_is_added_in_policy_rules": {
                                    "actions": {
                                        "Compose_the_firewall_rule_names": {
                                            "runAfter": {
                                                "For_each_firewall_rule_found": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@substring(variables('RuleName'),0,sub(length(variables('RuleName')),2))",
                                            "description": "This composes all the firewall rule names where address list is a part of"
                                        },
                                        "For_each_firewall_rule_found": {
                                            "foreach": "@body('Filter_array_address_list_from_policy')",
                                            "actions": {
                                                "Append_to_string_variable_rule_name": {
                                                    "runAfter": {},
                                                    "type": "AppendToStringVariable",
                                                    "inputs": {
                                                        "name": "RuleName",
                                                        "value": "@{items('For_each_firewall_rule_found')?['name']} ,"
                                                    },
                                                    "description": "This appends the firewall rule names in coma separated values"
                                                }
                                            },
                                            "runAfter": {},
                                            "type": "Foreach"
                                        },
                                        "Set_variable_firewall_rule_name": {
                                            "runAfter": {
                                                "Compose_the_firewall_rule_names": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "FirewallRuleName",
                                                "value": "The address list is a part of the firewall policy rules: @{outputs('Compose_the_firewall_rule_names')}."
                                            },
                                            "description": "This sets the firewall rule names with all the rules where address list is a part of"
                                        }
                                    },
                                    "runAfter": {
                                        "Filter_array_address_list_from_policy": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {
                                            "Set_variable_Firewall_Rule_name_if_address_list_is_not_present": {
                                                "runAfter": {},
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "FirewallRuleName",
                                                    "value": "The address list is not a part of any firewall policy rule."
                                                },
                                                "description": "Set Firewall rule name if address list not a part of any firewall rule name"
                                            }
                                        }
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "greater": [
                                                    "@length(body('Filter_array_address_list_from_policy'))",
                                                    0
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "This checks if address list is part of security firewall rule"
                                },
                                "Create_HTML_table_to_comment_in_the_Incident": {
                                    "runAfter": {
                                        "Condition__to_check_if_predefined_address_list_is_present_in_F5_Big_IP": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Table",
                                    "inputs": {
                                        "columns": [
                                            {
                                                "header": "IP Address",
                                                "value": "@item()?['IP_Address']"
                                            },
                                            {
                                                "header": "Status",
                                                "value": "@item()?['Status']"
                                            },
                                            {
                                                "header": "Is IP part of “@{parameters('AddressListName')}” address list? ",
                                                "value": "@item()?['Action']"
                                            }
                                        ],
                                        "format": "HTML",
                                        "from": "@variables('ConsolidatedComments')"
                                    },
                                    "description": "This creates a HTML table to update in the incident"
                                },
                                "F5BigIP_Base": {
                                    "runAfter": {},
                                    "type": "Workflow",
                                    "inputs": {
                                        "host": {
                                            "triggerName": "manual",
                                            "workflow": {
                                                "id": "[variables('F5BigIP_Base_id')]"
                                            }
                                        }
                                    },
                                    "description": "This calls the F5 Big IP base playbook for the authentication token"
                                },
                                "Filter_array_address_list_from_policy": {
                                    "runAfter": {
                                        "HTTP-Get_Global_Firewall_Policy_Rules": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Query",
                                    "inputs": {
                                        "from": "@body('HTTP-Get_Global_Firewall_Policy_Rules')?['items']",
                                        "where": "@contains(item()?['source']?['addressLists']?[0], parameters('AddressListName'))"
                                    },
                                    "description": "This filters address list from policy"
                                },
                                "HTTP-Get_Global_Firewall_Policy_Rules": {
                                    "runAfter": {
                                        "F5BigIP_Base": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Http",
                                    "inputs": {
                                        "headers": {
                                            "X-F5-Auth-Token": "@{body('F5BigIP_Base')?['X-F5-Auth-Token']}"
                                        },
                                        "method": "GET",
                                        "uri": "@{body('F5BigIP_Base')?['F5BigIPHost']}/mgmt/tm/security/firewall/policy/~Common~global_fwpolicy/rules/"
                                    },
                                    "description": "This fetches the list of all firewall rules present in F5 Big IP"
                                },
                                "HTTP-Get_specific_Address_list": {
                                    "runAfter": {
                                        "Condition_to_check_if__predefined_address_list_is_added_in_policy_rules": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Http",
                                    "inputs": {
                                        "headers": {
                                            "X-F5-Auth-Token": "@{body('F5BigIP_Base')?['X-F5-Auth-Token']}"
                                        },
                                        "method": "GET",
                                        "uri": "@{body('F5BigIP_Base')?['F5BigIPHost']}/mgmt/tm/security/firewall/address-list/@{parameters('AddressListName')}"
                                    },
                                    "description": "This gets the specific address list information"
                                }
                            },
                            "runAfter": {
                                "Initialize_variable_Rule_Name": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Terminate_if_IP_not_found_in_sentinel_body": {
                                        "runAfter": {},
                                        "type": "Terminate",
                                        "inputs": {
                                            "runError": {
                                                "code": "404",
                                                "message": "IP Address not found in Azure Sentinel Incident"
                                            },
                                            "runStatus": "Failed"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "contains": [
                                            "@outputs('Entities_-_Get_IPs')",
                                            "body"
                                        ]
                                    },
                                    {
                                        "greater": [
                                            "@length(body('Entities_-_Get_IPs')?['IPs'])",
                                            0
                                        ]
                                    }
                                ]
                            },
                            "type": "If",
                            "description": "This checks if body is present in Azure Sentinel"
                        },
                        "Entities_-_Get_IPs": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/entities/ip"
                            }
                        },
                        "Initialize_variable_Comment": {
                            "runAfter": {
                                "Entities_-_Get_IPs": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Comment",
                                        "type": "object"
                                    }
                                ]
                            },
                            "description": "This holds the value of comment variable"
                        },
                        "Initialize_variable_Consolidated_Comment": {
                            "runAfter": {
                                "Initialize_variable_Comment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "ConsolidatedComments",
                                        "type": "array"
                                    }
                                ]
                            },
                            "description": "This holds the value of consolidated comments"
                        },
                        "Initialize_variable_Firewall_Rule_Name": {
                            "runAfter": {
                                "Initialize_variable_Consolidated_Comment": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "FirewallRuleName",
                                        "type": "string"
                                    }
                                ]
                            },
                            "description": "This Holds the Firewall rule name"
                        },
                        "Initialize_variable_Rule_Name": {
                            "runAfter": {
                                "Initialize_variable_Firewall_Rule_Name": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "RuleName",
                                        "type": "string"
                                    }
                                ]
                            },
                            "description": "This holds the rule name"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinel_Connection'))]",
                                "connectionName": "[variables('AzureSentinel_Connection')]",
                                "id": "[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',resourceGroup().location,'/managedApis/azuresentinel')]",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "type": "MICROSOFT.WEB/CONNECTIONS",
            "apiVersion": "2016-06-01",
            "name": "[variables('AzureSentinel_Connection')]",
            "kind": "V1",
            "location": "[resourceGroup().location]",
            "properties": {
                "displayName": "[variables('AzureSentinel_Connection')]",
                "customParameterValues": {},
                "parameterValueType": "Alternative",
                "api": {
                    "id": "[concat('/subscriptions/',subscription().subscriptionId,'/providers/Microsoft.Web/locations/',resourceGroup().location,'/managedApis/azuresentinel')]"
                }
            }
        }

    ],
    "outputs": {}
}