{
  "schema_version": 4,
  "name": "Pull IOCs from Malware Traffic Analysis",
  "description": "Pull an RSS Feed from Malware Traffic Analysis, get recent articles, deduplicate them, and extract links. This Story then checks if the links are related to IOCs and, if so, downloads, unzips, and extracts IOCS from that zip file. These IOCs can be shared in another Story or uploaded to a threat intel platform, etc.\n\ntags: Intermediate, ThreatIntelligence, EMLfiles, Extract, IOCs, RSS, MalwareTrafficAnalysis, Deduplicate,\nicons: üìö, üòà, ü§ê\nvisibility: public",
  "guid": "998859226a0c7d553eaab21e4721c221",
  "slug": "pull_iocs_from_malware_traffic_analysis",
  "exported_at": "2022-07-11T17:36:52Z",
  "agents": [
    {
      "type": "Agents::HTTPRequestAgent",
      "name": "Get RSS Feed",
      "disabled": false,
      "guid": "7652bf8189adab099a9b73f005a11e08",
      "options": {
        "url": "https://www.malware-traffic-analysis.net/blog-entries.rss",
        "content_type": "json",
        "method": "get"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Explode Articles",
      "disabled": false,
      "guid": "70d48ac9705fe710b8c50fa506f81025",
      "options": {
        "mode": "explode",
        "path": "=get_rss_feed.body.rss.channel.item",
        "to": "individual_article"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Deduplicate",
      "disabled": false,
      "guid": "93c3f88d31e94c6b14b75c131b6f761e",
      "options": {
        "mode": "deduplicate",
        "path": " <<explode_articles.individual_article.link>>",
        "lookback": "100"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::HTTPRequestAgent",
      "name": "Get Article",
      "disabled": false,
      "guid": "6d14532152557c30283a321a774f1a1d",
      "options": {
        "url": " <<explode_articles.individual_article.link>>",
        "content_type": "json",
        "method": "get"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Extract Links",
      "disabled": false,
      "guid": "5b4342ce20e6578be9b0af21ce12ccff",
      "options": {
        "mode": "extract",
        "matchers": [
          {
            "path": "=get_article.body",
            "regexp": "href=\"([a-zA-Z0-9\\-.]+IOCs+[a-zA-Z0-9\\-.]+)",
            "to": "iocs_link"
          },
          {
            "path": "=get_article.body",
            "regexp": "href=\"([a-zA-Z0-9\\-.]+eml+[a-zA-Z0-9\\-.]+)",
            "to": "eml_link"
          },
          {
            "path": "=get_article.body",
            "regexp": "href=\"([a-zA-Z0-9\\-.]+pcap+[a-zA-Z0-9\\-.]+)",
            "to": "pcap_link"
          }
        ]
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::HTTPRequestAgent",
      "name": "Fetch IOCs",
      "disabled": false,
      "guid": "b2b8afd481608065a890ae1f997a08c9",
      "options": {
        "url": "<<REPLACE(explode_articles.individual_article.link, \"index.html\", \"\") |> REPLACE(%, \"index2.html\", \"\")>><<extract_links.iocs_link.first.first>>",
        "content_type": "json",
        "method": "get"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Unzip",
      "disabled": false,
      "guid": "c931772b7a453f3961c6cd53cc17bc3a",
      "options": {
        "mode": "message_only",
        "loop": false,
        "payload": {
          "iocs": "=BASE64_DECODE(fetch_iocs.body.base64encodedcontents) |> UNZIP(%, \"infected\")"
        }
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Decode File",
      "disabled": false,
      "guid": "4cd6759ec93e0c3a211bfef65389628a",
      "options": {
        "mode": "message_only",
        "loop": false,
        "payload": "<<BASE64_DECODE(unzip.iocs[0].base64encodedcontents)>>"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Extract IOCs",
      "disabled": false,
      "guid": "4b1893474c54700eefa69ca1b0764429",
      "options": {
        "mode": "extract",
        "matchers": [
          {
            "path": "=decode_file",
            "regexp": "\\b(?:[0-9]{1,3}\\.){3}[0-9]{1,3}\\b",
            "to": "ipv4"
          },
          {
            "path": "=decode_file",
            "regexp": "(?:(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){6})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:::(?:(?:(?:[0-9a-fA-F]{1,4})):){5})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:(?:[0-9a-fA-F]{1,4})):){4})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,1}(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:(?:[0-9a-fA-F]{1,4})):){3})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,2}(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:(?:[0-9a-fA-F]{1,4})):){2})(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,3}(?:(?:[0-9a-fA-F]{1,4})))?::(?:(?:[0-9a-fA-F]{1,4})):)(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,4}(?:(?:[0-9a-fA-F]{1,4})))?::)(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9]))\\.){3}(?:(?:25[0-5]|(?:[1-9]|1[0-9]|2[0-4])?[0-9])))))))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,5}(?:(?:[0-9a-fA-F]{1,4})))?::)(?:(?:[0-9a-fA-F]{1,4})))|(?:(?:(?:(?:(?:(?:[0-9a-fA-F]{1,4})):){0,6}(?:(?:[0-9a-fA-F]{1,4})))?::))))",
            "to": "ipv6"
          },
          {
            "path": "=decode_file",
            "regexp": "\\b[a-fA-F0-9]{32}\\b",
            "to": "md5"
          },
          {
            "path": "=decode_file",
            "regexp": "\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}\\b",
            "to": "email_addresses"
          },
          {
            "path": "=decode_file",
            "regexp": "\\b[a-fA-F0-9]{64}\\b",
            "to": "sha256"
          },
          {
            "path": "=decode_file",
            "regexp": "[A-Za-z]+:\\/\\/[A-Za-z0-9\\-_]+\\.[A-Za-z0-9\\-_:%&;\\?\\#\\/.=]+",
            "to": "urls"
          },
          {
            "path": "=decode_file",
            "regexp": "CVE-\\d{4}-\\d{4,7}",
            "to": "CVEs"
          }
        ]
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::TriggerAgent",
      "name": "Trigger if IOCs",
      "disabled": false,
      "guid": "23a68306f3ad75d883b710168fa4ab86",
      "options": {
        "rules": [
          {
            "type": "in",
            "value": ".",
            "path": "=extract_links.iocs_link.first.first"
          }
        ]
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      }
    },
    {
      "type": "Agents::HTTPRequestAgent",
      "name": "Fetch EML",
      "disabled": false,
      "guid": "9c3a8db9857d1393240bfd671858d84f",
      "options": {
        "url": "<<REPLACE(explode_articles.individual_article.link, \"index.html\", \"\") |> REPLACE(%, \"index2.html\", \"\")>><<extract_links.eml_link.first.first>>",
        "content_type": "json",
        "method": "get"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Unzip",
      "disabled": false,
      "guid": "43c404c5956405e75ef3f41a317c28df",
      "options": {
        "mode": "message_only",
        "loop": false,
        "payload": {
          "iocs": "=BASE64_DECODE(fetch_eml.body.base64encodedcontents) |> UNZIP(%, \"infected\")"
        }
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::EventTransformationAgent",
      "name": "Decode EML",
      "disabled": false,
      "guid": "cd21f8cd847f8b730430a3106422551b",
      "options": {
        "mode": "message_only",
        "loop": false,
        "payload": "=BASE64_DECODE(unzip.iocs[0].base64encodedcontents) |> EML_PARSE(%)"
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      },
      "schedule": null
    },
    {
      "type": "Agents::TriggerAgent",
      "name": "Trigger if EML",
      "disabled": false,
      "guid": "14acb7b2a9223aaa5b0f3a2c5eb98f67",
      "options": {
        "rules": [
          {
            "type": "in",
            "value": ".",
            "path": "=extract_links.eml_link.first.first"
          }
        ]
      },
      "reporting": {
        "time_saved_value": 0,
        "time_saved_unit": "minutes"
      },
      "monitoring": {
        "monitor_all_events": false,
        "monitor_failures": false,
        "monitor_no_events_emitted": null
      }
    }
  ],
  "diagram_notes": [
    {
      "content": "https://www.malware-traffic-analysis.net/site-logo-01.gif\n\nSimple story to demonstrate pulling an RSS Feed from [Malware Traffic Analysis](https://www.malware-traffic-analysis.net/), getting recent articles (and deduplicating them), and extracting links\n\nFrom there we check if links are related to IOCs and, if so, download, unzip and extract IOCS from that zip file.\n\nThis example also pulls and transforms any EML files uploaded to Malware Traffic Analysis.\n\nRequirements: None",
      "position": [
        -30.0,
        180.0
      ],
      "guid": "d7eb1c165cfedc0ea9ee229dfdcd668d",
      "width": null
    }
  ],
  "links": [
    {
      "source": 0,
      "receiver": 1
    },
    {
      "source": 1,
      "receiver": 2
    },
    {
      "source": 2,
      "receiver": 3
    },
    {
      "source": 3,
      "receiver": 4
    },
    {
      "source": 4,
      "receiver": 13
    },
    {
      "source": 4,
      "receiver": 9
    },
    {
      "source": 5,
      "receiver": 6
    },
    {
      "source": 6,
      "receiver": 7
    },
    {
      "source": 7,
      "receiver": 8
    },
    {
      "source": 9,
      "receiver": 5
    },
    {
      "source": 10,
      "receiver": 11
    },
    {
      "source": 11,
      "receiver": 12
    },
    {
      "source": 13,
      "receiver": 10
    }
  ],
  "diagram_layout": "{\"7652bf8189adab099a9b73f005a11e08\":[270,165],\"70d48ac9705fe710b8c50fa506f81025\":[270,270],\"93c3f88d31e94c6b14b75c131b6f761e\":[270,375],\"6d14532152557c30283a321a774f1a1d\":[270,480],\"5b4342ce20e6578be9b0af21ce12ccff\":[270,585],\"b2b8afd481608065a890ae1f997a08c9\":[270,795],\"c931772b7a453f3961c6cd53cc17bc3a\":[270,900],\"4cd6759ec93e0c3a211bfef65389628a\":[270,1005],\"4b1893474c54700eefa69ca1b0764429\":[270,1110],\"23a68306f3ad75d883b710168fa4ab86\":[270,690],\"9c3a8db9857d1393240bfd671858d84f\":[525,795],\"43c404c5956405e75ef3f41a317c28df\":[525,900],\"cd21f8cd847f8b730430a3106422551b\":[525,1005],\"14acb7b2a9223aaa5b0f3a2c5eb98f67\":[525,690]}",
  "send_to_story_enabled": false,
  "entry_agent_guid": null,
  "exit_agent_guids": [],
  "exit_agent_guid": null,
  "send_to_stories": [],
  "form": {
    "name": "Pull IOCs from Malware Traffic Analysis Form",
    "description": "",
    "fields": [],
    "visibility": "tenant",
    "agent_guid": null,
    "success_message": "Thank you for your submission"
  }
}